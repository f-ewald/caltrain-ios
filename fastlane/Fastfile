# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Generate screenshots"
  lane :screenshots do
    # Don't reset simulator to preserve location settings
    # Instead, just ensure simulator is booted and grant permissions
    sh("xcrun simctl boot 'iPhone 17 Pro' || true")  # Ensure simulator is booted
    sh("sleep 3")  # Wait for simulator to fully boot

    sh("xcrun simctl privacy 'iPhone 17 Pro' grant location net.fewald.caltrain")
    # Set location to San Francisco Caltrain Station as backup
    # Primary location is set via XCUIDevice.shared.location in the test itself
    sh("xcrun simctl location 'iPhone 17 Pro' set '37.7762,-122.3947'" )
    sh("sleep 2")  # Give location time to be set

    capture_screenshots(
      stop_after_first_error: true,
      number_of_retries: 1,
      scheme: "caltrain",
      configuration: "Release",
      xcargs: "ENABLE_TESTABILITY=YES",
      only_testing: ["caltrainUITests/Screenshot/testMainScreen"],
      erase_simulator: false,
      skip_open_summary: true
    )
  end
end
